package com.example.youngwoong

import android.content.Intent
import android.graphics.Color
import android.os.Bundle
import android.text.SpannableString
import android.text.Spanned
import android.text.style.ForegroundColorSpan
import android.util.Log
import android.view.View
import android.widget.ImageView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import kotlinx.coroutines.*
import okhttp3.*
import okhttp3.MediaType.Companion.toMediaTypeOrNull
import okhttp3.RequestBody.Companion.toRequestBody
import org.json.JSONObject

class GuidanceConfirmActivity : AppCompatActivity() {

    private var isFromCheckin: Boolean = false
    private val robotLocationUrl = NetworkConfig.getRobotLocationUrl()

    private val stationCoords = mapOf(
        "Ï¥àÏùåÌåå Í≤ÄÏÇ¨Ïã§" to Pair(-0.4028f, 16.5230f),
        "CT Í≤ÄÏÇ¨Ïã§" to Pair(-1.8587f, 16.6412f),
        "X-ray Í≤ÄÏÇ¨Ïã§" to Pair(-1.8373f, -7.4504f),
        "ÎåÄÏû•Ïïî ÏÑºÌÑ∞" to Pair(5.2334f, 18.8963f),
        "ÏúÑÏïî ÏÑºÌÑ∞" to Pair(8.0922f, 18.9370f),
        "ÌèêÏïî ÏÑºÌÑ∞" to Pair(9.3855f, 19.0064f),
        "Ïú†Î∞©Ïïî ÏÑºÌÑ∞" to Pair(11.6292f, 1.1619f),
        "ÎáåÏ¢ÖÏñë ÏÑºÌÑ∞" to Pair(9.8731f, 1.1293f)
    )

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_guidance_confirm)

        val cancelButton = findViewById<ImageView>(R.id.btn_cancel)
        val confirmButton = findViewById<ImageView>(R.id.btn_start_guidance)
        val textView = findViewById<TextView>(R.id.text_guidance_message)
        val highlightColor = Color.parseColor("#00696D")
        val mapView = findViewById<ImageView>(R.id.image_map)
        val destinationMarker = findViewById<ImageView>(R.id.image_destination_marker)
        val robotMarker = findViewById<ImageView>(R.id.image_robot_marker)

        val userName = intent.getStringExtra("user_name")
        val department = intent.getStringExtra("department")
        val selectedText = intent.getStringExtra("selected_text")
        val patientId = intent.getStringExtra("patient_id") ?: ""

        isFromCheckin = intent.getBooleanExtra(
            "isFromCheckin",
            false
        ) || (userName != null && department != null)

        // üìç ÏïàÎÇ¥ Î¨∏Íµ¨ Íµ¨ÏÑ±
        if (isFromCheckin) {
            val message = "${userName}Îãò ${department} Ï†ëÏàòÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.\nÏïàÎÇ¥Î•º ÏãúÏûëÌï†ÍπåÏöî?"
            val spannable = SpannableString(message)
            listOf(userName, department).forEach { value ->
                value?.let {
                    val start = message.indexOf(it)
                    if (start >= 0) {
                        spannable.setSpan(
                            ForegroundColorSpan(highlightColor),
                            start, start + it.length,
                            Spanned.SPAN_EXCLUSIVE_EXCLUSIVE
                        )
                    }
                }
            }
            textView.text = spannable
        } else if (selectedText != null) {
            val message = "${selectedText}Î•º ÏÑ†ÌÉùÌïòÏÖ®ÏäµÎãàÎã§.\nÏïàÎÇ¥Î•º ÏãúÏûëÌï†ÍπåÏöî?"
            val spannable = SpannableString(message)
            val start = message.indexOf(selectedText)
            if (start >= 0) {
                spannable.setSpan(
                    ForegroundColorSpan(highlightColor),
                    start, start + selectedText.length,
                    Spanned.SPAN_EXCLUSIVE_EXCLUSIVE
                )
            }
            textView.text = spannable
        } else {
            textView.text = "ÏïàÎÇ¥Î•º ÏãúÏûëÌï†ÍπåÏöî?"
        }

        // üìç Î™©Ï†ÅÏßÄ ÎßàÏª§ ÌëúÏãú
        val targetName = selectedText ?: department
        stationCoords[targetName]?.let { (x, y) ->
            val (px, py) = mapToPixelDirect(x, y)
            destinationMarker.visibility = View.VISIBLE
            destinationMarker.post {
                destinationMarker.x = mapView.x + px - destinationMarker.width / 2
                destinationMarker.y = mapView.y + py - destinationMarker.height / 2
            }
        }

        fetchRobotPosition(robotMarker, mapView)

        cancelButton.setOnClickListener {
            applyAlphaEffect(cancelButton)
            cancelButton.postDelayed({
                val intent = if (isFromCheckin) {
                    Intent(this, AuthenticationActivity::class.java)
                } else {
                    Intent(this, GuidanceActivity::class.java)
                }
                intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP or Intent.FLAG_ACTIVITY_SINGLE_TOP)
                startActivity(intent)
                overridePendingTransition(android.R.anim.fade_in, android.R.anim.fade_out)
                finish()
            }, 100)
        }

        confirmButton.setOnClickListener {
            applyAlphaEffect(confirmButton)
            confirmButton.postDelayed({
                val centerName = selectedText ?: department ?: "Ìï¥Îãπ ÏÑºÌÑ∞"
                val stationId = stationNameToId(centerName)

                Log.d(
                    "DirectionAPI",
                    "üîπ isFromCheckin: $isFromCheckin, patientId: $patientId, selectedText: $selectedText"
                )

                if (stationId != null) {
                    sendDirectionRequest(patientId, stationId)
                } else {
                    Log.e("DirectionAPI", "‚ùå Î™©Ï†ÅÏßÄ Îß§Ìïë Ïã§Ìå®: $centerName")
                }

                val intent = Intent(this, GuidanceWaitingActivity::class.java).apply {
                    putExtra("selected_text", centerName)
                    putExtra("isFromCheckin", isFromCheckin)
                    putExtra("patient_id", patientId)
                }
                startActivity(intent)
                overridePendingTransition(android.R.anim.fade_in, android.R.anim.fade_out)
                finish()
            }, 100)
        }
    }

    private fun fetchRobotPosition(robotMarker: ImageView, mapView: ImageView) {
        CoroutineScope(Dispatchers.IO).launch {
            try {
                val json = JSONObject().apply { put("robot_id", 3) }

                val requestBody = json.toString()
                    .toRequestBody("application/json; charset=utf-8".toMediaTypeOrNull())
                val request = Request.Builder()
                    .url(robotLocationUrl)
                    .post(requestBody)
                    .build()

                val client = OkHttpClient()
                val response = client.newCall(request).execute()
                val body = response.body?.string()

                if (!body.isNullOrEmpty()) {
                    val responseJson = JSONObject(body)
                    val x = responseJson.optDouble("x", Double.NaN).toFloat()
                    val y = responseJson.optDouble("y", Double.NaN).toFloat()

                    if (!x.isNaN() && !y.isNaN()) {
                        val (px, py) = mapToPixelDirect(x, y)
                        withContext(Dispatchers.Main) {
                            robotMarker.visibility = View.VISIBLE
                            robotMarker.x = mapView.x + px - robotMarker.width / 2
                            robotMarker.y = mapView.y + py - robotMarker.height / 2
                        }
                    } else {
                        Log.e("RobotPosition", "‚ùå Ï¢åÌëú ÌååÏã± Ïã§Ìå®: x=$x, y=$y")
                    }
                } else {
                    Log.e("RobotPosition", "‚ùå ÏùëÎãµ body ÏóÜÏùå")
                }
            } catch (e: Exception) {
                Log.e("RobotPosition", "‚ùå ÏúÑÏπò ÏöîÏ≤≠ Ïã§Ìå®", e)
            }
        }
    }

    private fun applyAlphaEffect(view: View) {
        view.alpha = 0.6f
        view.postDelayed({ view.alpha = 1.0f }, 100)
    }

    private fun mapToPixelDirect(x: Float, y: Float): Pair<Float, Float> {
        val xMin = -5.4995f
        val yMin = -10.0572f
        val xMax = 5.1066f
        val yMax = 9.8559f
        val imageWidth = 1020f
        val imageHeight = 530f

        val scaleX = imageWidth / (xMax - xMin)
        val scaleY = imageHeight / (yMax - yMin)

        val pixelX = (x - xMin) * scaleX
        val pixelY = (y - yMin) * scaleY

        return pixelX to pixelY
    }

    private fun stationNameToId(name: String?): Int? {
        return when (name) {
            "Ï¥àÏùåÌåå Í≤ÄÏÇ¨Ïã§" -> 1
            "CT Í≤ÄÏÇ¨Ïã§" -> 2
            "X-ray Í≤ÄÏÇ¨Ïã§" -> 3
            "ÎåÄÏû•Ïïî ÏÑºÌÑ∞" -> 4
            "ÏúÑÏïî ÏÑºÌÑ∞" -> 5
            "ÌèêÏïî ÏÑºÌÑ∞" -> 6
            "Ïú†Î∞©Ïïî ÏÑºÌÑ∞" -> 7
            "ÎáåÏ¢ÖÏñë ÏÑºÌÑ∞" -> 8
            else -> null
        }
    }

    private fun sendDirectionRequest(patientId: String?, stationId: Int) {
        CoroutineScope(Dispatchers.IO).launch {
            try {
                val url = if (isFromCheckin) {
                    NetworkConfig.getAuthDirectionUrl()
                } else {
                    NetworkConfig.getWithoutAuthDirectionUrl()
                }

                val json = JSONObject().apply {
                    put("robot_id", 3)
                    put("department_id", stationId)
                    if (isFromCheckin && !patientId.isNullOrBlank()) {
                        try {
                            put("patient_id", patientId.toInt())  // IntÎ°ú Î≥ÄÌôò
                        } catch (e: NumberFormatException) {
                            Log.e("DirectionAPI", "‚ùå patient_id Î≥ÄÌôò Ïã§Ìå®: $patientId", e)
                        }
                    }
                }

                Log.d("DirectionAPI", "üì§ ÏïàÎÇ¥ ÏöîÏ≤≠: $json ‚Üí $url")

                val request = Request.Builder()
                    .url(url)
                    .post(
                        json.toString()
                            .toRequestBody("application/json; charset=utf-8".toMediaTypeOrNull())
                    )
                    .build()

                val client = OkHttpClient()
                val response = client.newCall(request).execute()
                val responseBody = response.body?.string()

                Log.d("DirectionAPI", "üì• ÏùëÎãµ ÏΩîÎìú: ${response.code}")
                Log.d("DirectionAPI", "üì• ÏùëÎãµ Î∞îÎîî: $responseBody")
            } catch (e: Exception) {
                Log.e("DirectionAPI", "‚ùå ÏïàÎÇ¥ API Ìò∏Ï∂ú Ïã§Ìå®", e)
            }
        }
    }
}
